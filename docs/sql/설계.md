# 프로젝트 통계 스냅샷 설계 (Snapshot Mechanism)

## 1. 배경 및 목적
프로젝트의 멤버 변화(초대, 참여, 탈퇴)와 체크인 활동은 매일 발생합니다. 참여율과 멤버 목록은 시간에 따라 계속 변하므로, 특정 시점(매일)의 정확한 데이터를 보존하고 대규모 프로젝트 목록 조회 시의 성능을 최적화하기 위해 실시간 일일 스냅샷 메커니즘을 도입합니다.

## 2. 핵심 설계 원칙
- **실시간성 (Real-time Updates)**: 0시에 배치를 돌리는 대신, 멤버 정보나 체크인 데이터가 변경될 때마다 해당 날짜의 스냅샷을 즉시 갱신합니다.
- **소프트 삭제 (Soft Delete)**: 멤버 탈퇴 시 레코드를 물리적으로 삭제하지 않고 `deleted_at` 필드를 사용하여, 과거 날짜의 통계 계산 시 해당 멤버를 포함할 수 있도록 합니다.
- **데이터 일관성 (Trigger-based)**: 애플리케이션 로직이 아닌 데이터베이스 트리거를 통해 통계 데이터를 자동으로 관리하여 데이터 누락을 방지합니다.

## 3. 데이터 구조

### 3.1 일일 통계 테이블 (`tbl_project_daily_stats`)
| 컬럼명 | 타입 | 설명 |
| :--- | :--- | :--- |
| `project_id` | `uuid` | 프로젝트 고유 ID (PK, FK) |
| `stats_date` | `date` | 통계 기준 날짜 (PK) |
| `member_count` | `integer` | 해당 날짜 기준 활성 멤버 수 |
| `check_in_count` | `integer` | 해당 날짜의 총 체크인 수 |
| `avg_condition` | `numeric(3,1)` | 해당 날짜 체크인 멤버들의 평균 점수 |
| `participation_rate`| `integer` | 참여율 (`(check_in_count / member_count) * 100`) |

### 3.2 멤버 테이블 변경사항 (`tbl_project_members`)
- `deleted_at` 컬럼 추가: 멤버 탈퇴 시점을 기록하여 과거 통계 정확성 유지.

## 4. 통계 계산 공식

### 4.1 활성 멤버 수 산정
특정 날짜(`stats_date`) 기준 활성 멤버는 다음 조건을 만족해야 합니다.
1. `joined_at <= stats_date` (해당 날짜 혹은 그 이전에 가입)
2. `deleted_at IS NULL` OR `deleted_at > stats_date` (탈퇴하지 않았거나 해당 날짜 이후에 탈퇴)

### 4.2 참여율 (Participation Rate)
- `(해당 날짜의 체크인 수 / 해당 날짜의 활성 멤버 수) * 100` (소수점 버림)

## 5. 자동 동기화 메커니즘 (Triggers)
다음 상황 발생 시 자동으로 `fn_sync_daily_stats(project_id, date)` 함수가 호출됩니다.
- `tbl_project_members`: 새 멤버 추가(Insert), 멤버 탈퇴(Update: `deleted_at` 설정)
- `tbl_project_check_ins`: 체크인 등록(Insert), 체크인 내용 수정(Update), 체크인 취소(Delete)

## 6. 정기 배치 작업 (Cron Jobs)
실시간 트리거 외에도 데이터 정합성 유지와 일일 마감을 위해 정기 배치를 수행합니다.
- **도구**: Supabase `pg_cron` 확장 프로그램
- **주기**: 매일 한국 시간 00:00 (UTC 15:00)
- **작업 내용**: 모든 활성 프로젝트에 대해 `fn_sync_all_projects_daily_stats(CURRENT_DATE)` 호출
- **목적**: 트리거 누락 방지 및 매일 0시 기준 최종 통계 스냅샷 확정
